var that;
var connection;
var dbName = config.db.name;

function DB() {
	EventEmitter.call(this);
	
	that = this;
	
	connection = mysql.createConnection({ host: config.db.host, user: config.db.user, password: config.db.pass });
	connection.connect();
	
	that.on('selected', that.checkTables);
	
	that.selectDatabase();
}

util.inherits(DB, EventEmitter);

DB.prototype.onError = function (err, message) {
	console.log(message, err);
}

DB.prototype.selectDatabase = function (name) {
	if (typeof(name) !== 'undefined') {
		dbName = name;
	}
	
	connection.query('USE `' + dbName + '`', function (err, rows, fields) {
		if (err) {
			that.onError(err, 'Error selecting database "' + dbName + '"');
		} else {
			that.emit('selected', rows, fields);
		}
	});
}

DB.prototype.checkTables = function () {
	connection.query('SHOW TABLES', function (err, rows, fields) {
		if (err) {
			that.onError(err, 'Error listing tables for "' + dbName + '"');
		} else {
			if (!rows.length) {
				that.emit('beforeInstall', dbName);
				connection.query(
					"CREATE TABLE IF NOT EXISTS `movies` (\
						`id` int(10) unsigned NOT NULL AUTO_INCREMENT,\
						`const` varchar(255) COLLATE utf8_unicode_ci NOT NULL,\
						`title` varchar(255) COLLATE utf8_unicode_ci NOT NULL,\
						`directors` varchar(255) COLLATE utf8_unicode_ci DEFAULT NULL,\
						`rating` smallint(6) DEFAULT NULL,\
						`imdb_rating` float(2,1) DEFAULT NULL,\
						`runtime` smallint(6) DEFAULT NULL,\
						`year` varchar(255) COLLATE utf8_unicode_ci NOT NULL,\
						`release_date` date DEFAULT NULL,\
						PRIMARY KEY (`id`),\
						UNIQUE KEY `const` (`const`),\
						KEY `rating` (`rating`,`Year`)\
					) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci AUTO_INCREMENT=1;",
					function (err, rows, fields) {
						if (err) {
							that.onError(err, 'Could not setup database');
						}
					}
				)
				that.emit('afterInstall', dbName);
			}
			
			that.emit('ready', dbName);
		}
	});
}

module.exports = DB;